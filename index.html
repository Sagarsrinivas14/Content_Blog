<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Generation Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1D4ED8', // Blue-700
                        'secondary': '#6EE7B7', // Emerald-300
                        'background': '#F9FAFB', // Gray-50
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Custom scrollbar for output area */
        #output-area {
            max-height: 500px; /* Increased max height for longer content */
            overflow-y: auto;
        }

        #output-area::-webkit-scrollbar {
            width: 8px;
            background-color: #f1f1f1;
            border-radius: 4px;
        }

        #output-area::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* Gray-300 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-background min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl">
                <span class="text-primary">Content AI</span> Studio
            </h1>
            <p class="mt-2 text-lg text-gray-600">Generate real-time blog titles, full article drafts, and social media posts.</p>
        </header>

        <!-- Input Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <label for="topic-input" class="block text-sm font-medium text-gray-700 mb-2">What content should we generate?</label>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="topic-input" placeholder="E.g., The rise of sustainable finance or 5 easy productivity hacks"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                <button id="generate-button" 
                        class="bg-primary text-white p-3 rounded-lg font-semibold hover:bg-blue-800 transition duration-150 shadow-md flex items-center justify-center">
                    Generate Content Package
                </button>
            </div>
            
            <!-- Predefined Topics -->
            <div class="mt-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Popular Topics:</p>
                <div id="topic-suggestions" class="flex flex-wrap gap-2">
                    <!-- Topics will be inserted here by JS -->
                </div>
            </div>
        </div>

        <!-- Output Section -->
        <div class="mt-8">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex justify-between items-center">
                    Generated Content Draft
                    <button id="copy-button" class="bg-gray-200 text-gray-800 p-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition duration-150 hidden disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 1 1 0 01-2 0 2 2 0 00-2-2H9z" />
                        </svg>
                        Copy All
                    </button>
                </h2>

                <!-- Loading Spinner -->
                <div id="loading-indicator" class="hidden text-center py-12">
                    <svg class="animate-spin mx-auto h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-gray-500">Searching and generating a full content package...</p>
                </div>

                <!-- Content Display Area -->
                <div id="output-area" class="text-gray-700 min-h-[150px] space-y-4">
                    <p class="text-gray-400">Your generated multi-paragraph article draft and social media snippet will appear here.</p>
                </div>

                <!-- Sources Area -->
                <div id="sources-area" class="mt-6 pt-4 border-t border-gray-200 hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Sources (for factual grounding):</p>
                    <ul id="sources-list" class="list-none space-y-1 text-sm text-gray-500">
                        <!-- Sources will be inserted here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Error/Modal Area (Replacing alert()) -->
        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 id="modal-title" class="text-lg font-bold text-red-600 mb-2">Error</h3>
                <p id="modal-body" class="text-gray-700 mb-4">An unknown error occurred.</p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="bg-primary text-white px-4 py-2 rounded-lg w-full hover:bg-blue-800">Close</button>
            </div>
        </div>

    </div>

    <script type="module">
        // Global Constants
        // *** ACTION REQUIRED: INSERT YOUR GEMINI API KEY HERE TO RUN LOCALLY ***
        const API_KEY = "AIzaSyBZDDHEpAN5g-KANbXCVnaouDlqat4VJ6Q"; 
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 3;

        // UI Elements
        const topicInput = document.getElementById('topic-input');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');
        const outputArea = document.getElementById('output-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const sourcesArea = document.getElementById('sources-area');
        const sourcesList = document.getElementById('sources-list');
        const topicSuggestionsDiv = document.getElementById('topic-suggestions');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        // Predefined Topics (from Google Search results)
        const PREDEFINED_TOPICS = [
            "Future of AI in Marketing",
            "Personal Finance for Beginners",
            "The Benefits of Mindfulness",
            "DIY Home Renovation Hacks",
            "Latest Travel Destinations",
            "Mastering Short-Form Video Content",
            "Starting an Ethical E-commerce Business",
            "Building Resilience and Mental Toughness"
        ];
        
        // System instruction for the Gemini Model - UPDATED for 4-5 paragraphs and social media
        const SYSTEM_PROMPT = `You are a professional Content Strategist AI, skilled in generating engaging, well-structured content for professional blogs and social media. Based on the user's request, provide a comprehensive content package containing the following six labeled sections:
1.  **Blog Headline:** A compelling, attention-grabbing title (max 10 words).
2.  **Blog Introduction:** A concise introduction paragraph (max 75 words).
3.  **Body Paragraph 1:** A detailed paragraph focusing on the first key point (approx. 75-100 words).
4.  **Body Paragraph 2:** A detailed paragraph focusing on the second key point (approx. 75-100 words).
5.  **Blog Conclusion:** A summary paragraph (max 75 words) that restates the main idea and offers a final thought or call to action.
6.  **Social Media Snippet:** A highly engaging, short summary suitable for platforms like X/LinkedIn, including 3 relevant hashtags (max 30 words).

Format the output using clear markdown headings (e.g., **Blog Headline:**) for easy parsing. Ensure all information is factual and grounded in the search results provided.`;


        /**
         * Utility function to display custom messages (replaces alert()).
         * @param {string} title - The title of the message.
         * @param {string} body - The content of the message.
         * @param {string} type - 'error' or 'info'.
         */
        function showModal(title, body, type = 'error') {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            if (type === 'error') {
                modalTitle.classList.remove('text-primary');
                modalTitle.classList.add('text-red-600');
            } else {
                modalTitle.classList.remove('text-red-600');
                modalTitle.classList.add('text-primary');
            }
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        /**
         * Fetches content from the Gemini API with exponential backoff.
         * @param {string} query - The user's content topic.
         * @param {number} retryCount - Current retry attempt.
         */
        async function fetchGeneratedContent(query, retryCount = 0) {
            // Check for API Key before proceeding
            if (!API_KEY) {
                console.error("[Content AI Studio] API Key is missing. Cannot make network request.");
                showModal("API Key Missing", 
                          "The Content Generation Studio requires a Gemini API key to fetch real-time content. Please insert your API key into the 'API_KEY' constant in the code to run this locally.", 
                          'error');
                return { text: null, sources: [] };
            }

            console.log(`[Content AI Studio] Attempting to generate content for: "${query}" (Retry: ${retryCount})`);
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log(`[Content AI Studio] API Response Status: ${response.status}`);


                if (!response.ok) {
                    if (response.status === 429 && retryCount < MAX_RETRIES) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        console.log(`[Content AI Studio] Rate limit hit. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchGeneratedContent(query, retryCount + 1);
                    }
                    // Log the full error response text if available
                    const errorText = await response.text();
                    console.error(`[Content AI Studio] Fetch failed. Status: ${response.status}. Body: ${errorText}`);
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    console.log("[Content AI Studio] Content successfully generated.");
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };
                } else {
                    console.error("[Content AI Studio] Response received but content field is missing or malformed.", result);
                    throw new Error("Received an empty or malformed response from the model.");
                }

            } catch (error) {
                console.error("[Content AI Studio] Gemini API error caught:", error.message);
                if (retryCount < MAX_RETRIES) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    console.log(`[Content AI Studio] Request failed. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchGeneratedContent(query, retryCount + 1);
                }
                showModal("Content Generation Failed", "We couldn't generate the content. Please try a different query or ensure you are running the file on a local server (see instructions below).");
                return { text: null, sources: [] };
            }
        }

        /**
         * Renders the generated content and sources to the UI.
         */
        function renderOutput(content, sources) {
            outputArea.innerHTML = '';
            sourcesList.innerHTML = '';

            if (content) {
                // Render content using Markdown processing (simplified)
                const parts = content.split('\n').filter(p => p.trim() !== '');
                let fullTextForCopy = '';

                parts.forEach(part => {
                    const element = document.createElement('div');
                    
                    if (part.startsWith('1. **Blog Headline:**')) {
                        const headline = part.replace('1. **Blog Headline:**', '').trim();
                        element.innerHTML = `<h3 class="text-3xl font-extrabold text-primary mb-4">${headline}</h3>`;
                        fullTextForCopy += `TITLE: ${headline}\n\n`;
                    } else if (part.startsWith('2. **Blog Introduction:**')) {
                        const intro = part.replace('2. **Blog Introduction:**', '').trim();
                        element.innerHTML = `<p class="text-lg italic text-gray-700 mb-6">${intro}</p>`;
                        fullTextForCopy += `Introduction: ${intro}\n\n`;
                    } else if (part.startsWith('3. **Body Paragraph 1:**')) {
                        const body1 = part.replace('3. **Body Paragraph 1:**', '').trim();
                        element.innerHTML = `<p class="text-lg font-semibold text-gray-800 mb-1">Key Insight 1:</p><p class="text-gray-700 mb-6">${body1}</p>`;
                        fullTextForCopy += `Body Paragraph 1: ${body1}\n\n`;
                    } else if (part.startsWith('4. **Body Paragraph 2:**')) {
                        const body2 = part.replace('4. **Body Paragraph 2:**', '').trim();
                        element.innerHTML = `<p class="text-lg font-semibold text-gray-800 mb-1">Key Insight 2:</p><p class="text-gray-700 mb-6">${body2}</p>`;
                        fullTextForCopy += `Body Paragraph 2: ${body2}\n\n`;
                    } else if (part.startsWith('5. **Blog Conclusion:**')) {
                        const conclusion = part.replace('5. **Blog Conclusion:**', '').trim();
                        element.innerHTML = `<p class="text-lg font-semibold text-primary mt-4 mb-1">Conclusion:</p><p class="bg-gray-100 p-4 rounded-lg text-gray-700">${conclusion}</p>`;
                        fullTextForCopy += `Conclusion: ${conclusion}\n\n`;
                    } else if (part.startsWith('6. **Social Media Snippet:**')) {
                        const snippet = part.replace('6. **Social Media Snippet:**', '').trim();
                        element.innerHTML = `<p class="text-xl font-semibold text-primary mt-6 mb-1 border-t pt-4 border-gray-200">Social Media Post:</p><p class="bg-secondary bg-opacity-20 p-3 rounded-lg text-gray-800 font-medium">${snippet}</p>`;
                        fullTextForCopy += `Social Media Snippet: ${snippet}\n`;
                    } else {
                        // Fallback for any other text
                        element.textContent = part;
                    }
                    outputArea.appendChild(element);
                });
                
                // Store the raw text for copying
                copyButton.dataset.content = fullTextForCopy.trim();
                copyButton.classList.remove('hidden');
                copyButton.disabled = false;

                // Render sources
                if (sources.length > 0) {
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline transition duration-150">
                                ${source.title || 'Untitled Source'}
                            </a>
                        `;
                        sourcesList.appendChild(li);
                    });
                    sourcesArea.classList.remove('hidden');
                } else {
                     sourcesArea.classList.add('hidden');
                }

            } else {
                outputArea.innerHTML = '<p class="text-gray-400">Your generated multi-paragraph article draft and social media snippet will appear here. Try a different topic!</p>';
                sourcesArea.classList.add('hidden');
                copyButton.classList.add('hidden');
            }
        }

        /**
         * Main event handler for content generation.
         */
        async function generateContentHandler() {
            const query = topicInput.value.trim();
            if (!query) {
                showModal("Input Required", "Please enter a topic or select a suggestion before generating content.", 'info');
                return;
            }

            // UI State: Loading
            generateButton.disabled = true;
            topicInput.disabled = true;
            copyButton.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            outputArea.innerHTML = '';
            sourcesArea.classList.add('hidden');

            const result = await fetchGeneratedContent(query);

            // UI State: Done
            generateButton.disabled = false;
            topicInput.disabled = false;
            loadingIndicator.classList.add('hidden');

            if (result.text) {
                renderOutput(result.text, result.sources);
            } else {
                renderOutput(null, []); // Clear output on failure
                
                // Show specific instruction if content failed
                showModal("Content Generation Failed - Debugging Tip", 
                          "The Content Studio is failing with a **403 Forbidden** error, which means the **API Key is missing**. Please open your browser's Developer Console (F12) and check the JavaScript code. You need to insert your personal Gemini API key where the code says `const API_KEY = \"\";` to fix the issue.", 'error');
            }
        }

        /**
         * Handles copying the generated text to the clipboard.
         */
        function copyContentHandler() {
            const content = copyButton.dataset.content;
            if (!content) {
                showModal("Copy Error", "No content available to copy.", 'info');
                return;
            }
            
            // Temporary element for copying
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = content;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 1 1 0 01-2 0 2 2 0 00-2-2H9z" />
                        </svg>
                        Copy All
                    `;
                }, 2000);
            } catch (err) {
                showModal("Copy Error", "Failed to copy text. Please manually select and copy the output.", 'error');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }

        /**
         * Initializes the suggestion buttons.
         */
        function initializeSuggestions() {
            PREDEFINED_TOPICS.forEach(topic => {
                const button = document.createElement('button');
                button.textContent = topic;
                button.className = 'text-sm bg-secondary text-gray-800 px-3 py-1 rounded-full hover:bg-emerald-400 transition duration-150 shadow-sm';
                button.onclick = () => {
                    topicInput.value = topic;
                    generateContentHandler();
                };
                topicSuggestionsDiv.appendChild(button);
            });
        }

        // Event Listeners
        generateButton.addEventListener('click', generateContentHandler);
        copyButton.addEventListener('click', copyContentHandler);
        topicInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateContentHandler();
            }
        });

        // Initialize on load
        window.onload = initializeSuggestions;

    </script>
</body>
</html>
